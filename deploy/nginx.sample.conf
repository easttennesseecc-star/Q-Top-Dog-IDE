# Sample NGINX config for Q-Top-Dog-IDE
# - Serves the SPA
# - Redirects unauthenticated /app/* to /login based on a session cookie
# IMPORTANT: This requires your backend to set an httpOnly cookie (e.g., qid_session)
# If you rely on localStorage tokens, NGINX cannot detect auth. Prefer httpOnly cookies in production.

server {
    listen 80;
    server_name topdog-ide.com www.topdog-ide.com;

    root /var/www/topdog-ide/frontend; # adjust to your build output path
    index index.html;

    # Basic static file caching
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
        expires 30d;
        access_log off;
        add_header Cache-Control "public, max-age=2592000, immutable";
        try_files $uri =404;
    }

    # Robots and sitemap
    location = /robots.txt { try_files $uri =404; }
    location = /sitemap.xml { try_files $uri =404; }

    # Redirect /app/* to /login when no session cookie is present
    # Assumes your backend sets: Set-Cookie: qid_session=1; HttpOnly; Secure; Path=/
    location ~* ^/app(/.*)?$ {
        if ($http_cookie !~* "qid_session=") {
            return 302 /login;
        }
        # Serve SPA app shell and let client-side router handle it
        try_files $uri /index.html;
    }

    # OAuth callbacks should hit the SPA (or backend if proxied separately)
    location ~* ^/(oauth|auth/oauth)/callback$ {
        try_files $uri /index.html;
    }

    # Default SPA fallback
    location / {
        try_files $uri /index.html;
    }
}
