# NGINX stub with external auth to OPA for API policy checks
# Requires: nginx, ngx_http_auth_request_module, and OPA running at http://opa:8181

worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events { worker_connections 1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;

  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

  access_log  /var/log/nginx/access.log  main;

  sendfile        on;
  keepalive_timeout  65;

  upstream backend {
    server backend:8000;
  }

  upstream opa {
    server opa:8181;
  }

  server {
    listen       8080;
    server_name  _;

    # Minimal stub_status for Prometheus exporter
    location /stub_status {
      stub_status;
      access_log off;
      allow all;
    }

    # Build auth input for OPA via subrequest
    location = /_opa_authz {
      internal;
      proxy_pass http://opa/v1/data/topdog/api/allow;
      proxy_set_header Content-Type "application/json";
      proxy_method POST;
      proxy_pass_request_body on;

      # Compose input from headers
      set $req_body '{"input":{}}';
      # Example: include method, path, api_key header
      proxy_set_header X-Method $request_method;
      proxy_set_header X-Path $request_uri;
      proxy_set_header X-Api-Key $http_x_api_key;
    }

    location / {
      # Call OPA for authorization
      auth_request /_opa_authz;

      # If OPA denies, return 403 with message if available
      error_page 401 =403 /__deny;

      proxy_pass http://backend;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /__deny {
      internal;
      default_type application/json;
      return 403 '{"error":"policy_denied"}';
    }
  }
}
